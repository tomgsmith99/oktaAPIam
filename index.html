<!DOCTYPE HTML>
<html>
<head>
	<meta charset='utf-8' />
	<meta name='viewport' content='width=device-width, initial-scale=1' />

	<!-- ******* TITLE OF PAGE ******** -->

	<title>Okta + Mulesoft integration</title>

	<!-- ******* CSS *******************-->
	
	<link rel = 'stylesheet' href = 'https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.1.0/css/okta-sign-in.min.css'/>

	<link rel = 'stylesheet' href = 'https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.1.0/css/okta-theme.css'/>

	<!-- BOOTSTRAP CSS -->
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<!-- ******* JAVASCRIPT *******************-->

	<script src = 'https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.1.0/js/okta-sign-in.min.js'></script>

	<script
	  src="https://code.jquery.com/jquery-3.2.1.min.js"
	  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
	  crossorigin="anonymous"></script>

	<script>

	window.onload = function() {

		// look for login url in local storage
		// just for reference
		if (localStorage.getItem("authURI")) {
			console.log("authn uri: " + localStorage.getItem("authURI"));
		}

		// look for access token in url
		if (window.location.hash) {
			getAccessToken(window.location.hash.substring(1));
		}

		// for debugging user sessions
		checkForOktaSession();
	};

	</script>

	<script>

	function checkForOktaSession() {

		// Initialize the Okta widget
		var oktaSignIn = new OktaSignIn({
			baseUrl: '{{oktaTenant}}'
		});

		// Check for an Okta session
		oktaSignIn.session.exists(function (exists) {
			if (exists) {
				console.log("there is an active Okta session.");

				oktaSignIn.session.get(function (res) {
					$.ajax({
						type: "GET",
						dataType: 'json',
						url: "{{oktaTenant}}/api/v1/users/" + res.userId,

						xhrFields: {
							withCredentials: true
						},
						success: function (data) {
							console.log("the given_name is: " + data.profile.firstName);
						},
						error: function (textStatus, errorThrown) {
							// console.log('error retrieving session: ' + JSON.stringify(textStatus));
							// console.log(errorThrown);
						},
						async: true
					});
				});
			}
			else {
				console.log("there is not an active Okta session.");
				console.log("-------------------------------");
			}
		});
	}

	function getAccessToken(hash) {

		var arr = hash.split("&");

		// key/value pair
		var kvp = arr[0].split("=");

		var accessToken = kvp[1];

		console.log("accessToken: " + accessToken);

		updateLinks(accessToken);

		inspectToken(accessToken);
	}

	function inspectToken(accessToken) {

		$.ajax({
			type: 'POST',
			data: JSON.stringify({ "accessToken": accessToken}),
			contentType: 'application/json',
			url: '/introspect',
			success: function(data) {
				console.log(data);

				var obj = JSON.parse(data);

				$("#inspectedToken").html("<pre>" + JSON.stringify(obj, null, 1) + "</pre>");

				$("#introspectResults").show();
			}
		});
	}

	function killSession(){
		signout(function(error, status) {
			if (error) { console.log("could not sign the user out."); }
			else {
				location.reload(true);
			}
		});
	}

	function redirectToOkta(level) {
		signout( function(error, status) {
			if (error) { console.log("could not sign the user out."); }
			else {
				console.log("signed the user out successfully.");

				var uri = '{{oktaTenant}}/oauth2/{{authServerID}}/v1/authorize?response_type=token&client_id={{clientID}}&redirect_uri={{redirect_uri}}&state=someState&nonce=someNonce&prompt=login&scope=api-read-silver';
				
				if (level == "gold") {
					uri += " api-read-gold";
				}

				localStorage.setItem("authURI", uri);

				window.location = uri;
			}
		});
	}

	function signout(callback) {
		localStorage.removeItem("authURI");

		console.log("attempting to sign out...");
		$.ajax({
			type: "DELETE",
			dataType: 'json',
			url: "{{oktaTenant}}/api/v1/sessions/me",
			xhrFields: {
				withCredentials: true
			},
			success: function (data) {
				return callback(null, "success");
			},
			error: function (textStatus, errorThrown) {
				// console.log('error deleting session: ' + JSON.stringify(textStatus));
				// console.log(errorThrown);
				return callback(null, "success");
			},
			async: true
		});
	}

	function updateLinks(accessToken) {

		var shortToken = accessToken.substring(0,8);

		var planetsLink = '<a target="_blank" href="{{proxy_uri}}/planets?access_token=' + accessToken + '">{{proxy_uri}}/planets?access_token=' + shortToken + '...</a>';

		$("#planetsLink").html(planetsLink);

		var moonsLink = '<a target="_blank" href="{{proxy_uri}}/moons?access_token=' + accessToken + '">{{proxy_uri}}/moons?access_token=' + shortToken + '...</a>';

		$("#moonsLink").html(moonsLink);
	}

	</script>

</head>

<body>
<!-- Wrapper -->
<div id="container">

	<div class="container">
		<div class="header clearfix">
			<nav>
				<ul class="nav nav-pills pull-right">
					<li role="presentation" class="active"><a href="#" onclick="killSession()">Home / Log out</a></li>
				</ul>
			</nav>
			
			<h3 class="text-muted">Mulesoft + Okta</h3>
		</div>

		<div class="well" style="background-color: rgb(234, 239, 247)">
			<div class="row" style="vertical-align: top">
				<div class="col-md-6" style="vertical-align: top">

					<p>Welcome to Okta's Solar System API, a demonstration of an integration between Okta and Mulesoft. Mulesoft is protecting the API using Okta's OAuth2-based authentication and authorization.</p>

					<p>Just authenticate as one of the users on the right to get started.</p>

					<div id = "introspectResults">
						<div class = "panel panel-success">
							<div class = "panel-heading">Successful authentication! Click one of the okta-solar-system urls to test your access token. Current token, inspected: </div>
							<div class = "panel-body" id="inspectedToken">[none]</div>
						</div>
					</div>


					<div class="panel panel-info">
						<div class="panel-heading">
							<h3 class="panel-title">readme</h3>
						</div>
						<div class="panel-body">
							<p>In this scenario, one user (Carl Sagan) is subscribed to the "silver" level of access, which means he will be able to access the /planets endpoint with his access token by virtue of the "api-read-silver" scope. Okta will mint the access token and include the "api-read-silver" scope because Carl belongs to the "silverSubscribers" group in Okta.</p>

							<p>Similarly, another user (Jodi Foster) is subscribed to the "gold" level of access, which means she will be able to access the /moons endpoint, and she will also be able to access the /planets endpoint by virtue of the scopes included in her access token.</p>

							<p>Try clicking on the links as an unauthenticated user, and then as Carl and Jodi to get a sense of how the access tokens work with the API endpoints.</p>
						</div>
					</div>

				</div>

				<div class="col-md-6">

					<div class = "panel panel-default">
						<div class = "panel-heading">
							SILVER ACCESS: A list of the planets
						</div>
						<div class = "panel-body">
							<div class = "row">
								<div class = "col-sm-6">
									<p>username: carl.sagan
									<br>
									password: mars</p>
								</div>
								<div class = "col-sm-6" style="text-align: center;">
									<button type="button" class="btn" onclick="redirectToOkta('silver')">authenticate</button>
								</div>
							</div>
							<span id = "planetsLink"><a href= "{{proxy_uri}}/planets" target = "_blank">{{proxy_uri}}/planets</a></span>
						</div>
					</div>

					<div class = "panel panel-warning">
						<div class = "panel-heading">
							GOLD Access: A list of (selected) moons
						</div>
						<div class = "panel-body">
							<div class = "row">
								<div class = "col-sm-6">
									<p>username: jodi.foster
									<br>
									password: mars</p>
								</div>
								<div class = "col-sm-6" style="text-align: center;">
									<button type="button" class="btn btn-warning" onclick="redirectToOkta('gold')">authenticate</button>
								</div>
							</div>
							<span id = "moonsLink"><a href= "{{proxy_uri}}/moons" target = "_blank">{{proxy_uri}}/moons</a></span>
						</div>
					</div>

				</div>

		</div>

	</div>


</div>

</body>
</html>